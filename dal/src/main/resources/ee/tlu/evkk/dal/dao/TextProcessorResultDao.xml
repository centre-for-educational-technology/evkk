<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ee.tlu.evkk.dal.dao.TextProcessorResultDao">

  <select id="upsert" resultType="java.util.UUID" useCache="false" flushCache="true">
    insert into core.text_processor_result (text_processor_result_id,
                                            text_hash,
                                            type,
                                            version,
                                            result)
    values (coalesce(#{textProcessorResult.textProcessorResultId}, uuid_generate_v4()),
            #{textProcessorResult.textHash},
            #{textProcessorResult.type},
            #{textProcessorResult.version},
            #{textProcessorResult.result})
    on conflict on constraint text_processor_result_uq_text_hash_type_version
      do update set result = excluded.result
    returning text_processor_result_id;
  </select>

  <select id="findResultForTypeAndVersion" resultType="ee.tlu.evkk.dal.dto.TextProcessorResult">
    select *
    from core.text_processor_result tpr
    where tpr.text_hash = #{textHash}
      and tpr.type = #{type}
      and tpr.version = #{version};
  </select>

</mapper>
